<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Цветной Чат</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .message {
            padding: 10px;
            margin: 5px;
            border-radius: 5px;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #messages {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #ccc;
            margin: 10px 0;
            background-color: white;
            border-radius: 8px;
        }
        .hidden {
            display: none;
        }
        .color-option {
            width: 30px;
            height: 30px;
            margin: 5px;
            cursor: pointer;
            display: inline-block;
            border: 2px solid transparent;
            border-radius: 5px;
            transition: transform 0.2s;
        }
        .color-option:hover {
            transform: scale(1.1);
        }
        .color-option.selected {
            border: 2px solid black;
        }
        #authForm {
            padding: 20px;
            text-align: center;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .number-input {
            font-size: 18px;
            width: 60px;
            margin: 10px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        #messageInput {
            width: 80%;
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            padding: 8px 15px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <div id="authForm">
        <h2>Выберите ваш цвет и число</h2>
        <div id="colorPicker">
            <div class="color-option" style="background-color: #FF0000" data-color="#FF0000"></div>
            <div class="color-option" style="background-color: #00FF00" data-color="#00FF00"></div>
            <div class="color-option" style="background-color: #0000FF" data-color="#0000FF"></div>
            <div class="color-option" style="background-color: #FF00FF" data-color="#FF00FF"></div>
            <div class="color-option" style="background-color: #00FFFF" data-color="#00FFFF"></div>
            <div class="color-option" style="background-color: #FFFF00" data-color="#FFFF00"></div>
        </div>
        <input type="number" id="userNumber" class="number-input" min="0" max="999" placeholder="123">
        <button onclick="login()">Войти</button>
    </div>

    <div id="chatForm" class="hidden">
        <h2>Чат</h2>
        <div id="messages"></div>
        <div style="display: flex; margin-top: 10px;">
            <input type="text" id="messageInput" placeholder="Введите сообщение">
            <button onclick="sendMessage()">Отправить</button>
        </div>
        <button onclick="logout()" style="margin-top: 10px;">Выйти</button>
    </div>

    <script>
        // Создаем клиент Supabase до использования
        const supabaseClient = supabase.createClient(
            'https://mdgffqzkzkfpomcccljo.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1kZ2ZmcXpremtmcG9tY2NjbGpvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwNjYzMTIsImV4cCI6MjA2MTY0MjMxMn0.H2-v0wwx2Vi6-a3BP4UdLAWrAfWgt1SYQJhm44rUmo4'
        );

        // Объявляем переменные в начале
        let currentUser = null;
        let selectedColor = null;

        // Инициализируем обработчики цвета после загрузки DOM
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.color-option').forEach(opt => 
                        opt.classList.remove('selected')
                    );
                    option.classList.add('selected');
                    selectedColor = option.dataset.color;
                });
            });

            // Добавляем обработчик Enter для отправки сообщения
            document.getElementById('messageInput')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        });

        async function login() {
            const userNumber = document.getElementById('userNumber').value;
            
            if (!selectedColor || !userNumber) {
                alert('Пожалуйста, выберите цвет и введите число');
                return;
            }

            currentUser = {
                color: selectedColor,
                number: userNumber
            };

            document.getElementById('authForm').classList.add('hidden');
            document.getElementById('chatForm').classList.remove('hidden');
            
            await loadMessages();
            subscribeToMessages();
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const messageText = messageInput.value.trim();
            
            if (messageText && currentUser) {
                try {
                    const { error } = await supabaseClient
                        .from('messages')
                        .insert([{
                            user_color: currentUser.color,
                            user_number: currentUser.number,
                            message: messageText
                        }]);

                    if (error) throw error;
                    messageInput.value = '';
                } catch (error) {
                    console.error('Error sending message:', error);
                    alert('Ошибка отправки сообщения');
                }
            }
        }

        async function loadMessages() {
            try {
                const { data, error } = await supabaseClient
                    .from('messages')
                    .select('*')
                    .order('created_at', { ascending: true });

                if (error) throw error;
                displayMessages(data);
            } catch (error) {
                console.error('Error loading messages:', error);
                alert('Ошибка загрузки сообщений');
            }
        }

        function subscribeToMessages() {
            supabaseClient
                .channel('public:messages')
                .on('postgres_changes', { 
                    event: 'INSERT', 
                    schema: 'public', 
                    table: 'messages' 
                }, payload => {
                    addMessageToDisplay(payload.new);
                })
                .subscribe();
        }

        function displayMessages(messages) {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = '';
            
            messages.forEach(message => {
                addMessageToDisplay(message);
            });
            
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addMessageToDisplay(message) {
            const messagesDiv = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            messageElement.style.backgroundColor = message.user_color;
            messageElement.textContent = `Пользователь ${message.user_number}: ${message.message}`;
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function logout() {
            currentUser = null;
            selectedColor = null;
            document.querySelectorAll('.color-option').forEach(opt => 
                opt.classList.remove('selected')
            );
            document.getElementById('userNumber').value = '';
            document.getElementById('authForm').classList.remove('hidden');
            document.getElementById('chatForm').classList.add('hidden');
            document.getElementById('messages').innerHTML = '';
        }
    </script>
</body>
</html>
